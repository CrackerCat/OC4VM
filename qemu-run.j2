#!/bin/sh
# OC4VM VERSION
# {{VERSION}}

# set -x

# Check if the number of arguments is not equal to 1
if [[ $# -ne 1 ]]; then
    echo "Usage: $0 <tcg or hvf>"
    exit 1
fi

# Get the value of the parameter
param="$1"

# Check if the parameter is either "tcg" or "hvf"
if [[ "$param" != "tcg" ]] && [[ "$param" != "hvf" ]]; then
    echo "Parameter must be 'tcg' or 'hvf'."
    exit 1
fi

# Your script logic goes here based on the provided parameter
if [[ "$param" == "tcg" ]]; then
    accel="tcg,tb-size=8192"
elif [[ "$param" == "hvf" ]]; then
    accel="hvf"
fi

qemu-system-x86_64 \
-name "{{DESCRIPTION}}" \
-cpu Skylake-Server,-pdpe1gb,-avx512f,-avx512dq,-avx512cd,-avx512bw,-avx512vl \
-smp cpus=2,sockets=1,cores=2,threads=1 \
-machine q35,vmport=on,i8042=off,hpet=off \
-accel $accel \
-m 4096 \
-nodefaults \
-device ich9-intel-hda \
-device virtio-net-pci,mac=66:C9:75:99:89:AC,netdev=net0 \
-netdev user,id=net0,hostfwd=tcp::5959-:5900 \
-device vmware-svga,vgamem_mb=128 \
-device virtio-rng-pci \
-global ICH9-LPC.disable_s3=1 \
-drive if=pflash,format=raw,unit=0,file.filename=./edk2-x86_64-code.fd,file.locking=off,readonly=on \
-drive "if=pflash,format=raw,unit=1,file=./efi_vars.fd" \
-device virtio-blk,drive=opencore,bootindex=0 \
-drive "if=none,media=disk,id=opencore,file=opencore.qcow2,discard=unmap,detect-zeroes=unmap,format=qcow2" \
-device virtio-blk,drive=macos,bootindex=1 \
-drive "if=none,media=disk,id=macos,file=macos.qcow2,discard=unmap,detect-zeroes=unmap" \
-device qemu-xhci \
-device usb-tablet \
-device usb-kbd \
-smbios type=2 \
{%- if SERIAL == '1' %}
-chardev stdio,id=char0,mux=on,logfile=serial.log,signal=off \
-serial chardev:char0 \
-mon chardev=char0
{%- endif %}
